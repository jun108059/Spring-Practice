# ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ ì´í•´ ì˜ˆì œ

## 0. í”„ë¡œì íŠ¸ Spec

- Java 11 ì„¤ì¹˜
- IDE : IntelliJ
- Project : Gradle Project
- Spring boot : 2.4.5
- Packaging : Jar

## 1. ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ ìƒì„±

ìŠ¤í”„ë§ ë¶€íŠ¸ ìŠ¤íƒ€í„°ì—ì„œ ìœ„ ì„¤ì •ëŒ€ë¡œ í”„ë¡œì íŠ¸ ìƒì„±!

## 2. ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ê³¼ ì„¤ê³„

íšŒì›

1. íšŒì› ê°€ì…, ì¡°íšŒ
2. íšŒì› â†’ ì¼ë°˜, VIP
3. íšŒì› ë°ì´í„°ëŠ” ìì²´ DB êµ¬ì¶•, ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ê°€ëŠ¥`(ë¯¸í™•ì •)`

ì£¼ë¬¸ê³¼ í• ì¸ ì •ì±…

1. íšŒì›ì€ ìƒí’ˆì„ ì£¼ë¬¸
2. íšŒì› ë“±ê¸‰ì— ë”°ë¼ í• ì¸ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤.
3. í• ì¸ ì •ì±…ì€ ëª¨ë“  VIP 1000ì› í• ì¸ ê³ ì •`(ë³€ê²½ê°€ëŠ¥)`
4. í• ì¸ ì •ì±…ì˜ ë³€ë™ ê°€ëŠ¥ì„±ì´ ì—„ì²­ í¼

<aside>

ğŸ’¡ ìŠ¤í”„ë§ê³¼ ì™„ì „ ìƒê´€ì—†ì´ POJOë¡œ êµ¬í˜„ ë¨¼ì € í•´ë³¸ë‹¤.

</aside>

![image](https://user-images.githubusercontent.com/42997924/180614236-5a26d876-1463-4920-aed4-8bed802d9b55.png)

- ì‹œê°„ë‚˜ë©´ ê³µë¶€í•˜ê¸°(ConcurrentHashMap)

  [Java - Collection - Map - ConcurrentHashMap - ì¡°ê¸ˆ ëŠ¦ì€, IT ê´€ìŠµ ë„˜ê¸° (JS.Kim)](http://blog.breakingthat.com/2019/04/04/java-collection-map-concurrenthashmap/)

## 3. í”„ë¡œì íŠ¸ ì˜ˆì œ ë§Œë“¤ê¸°

### íšŒì› ë§Œë“¤ê¸°

- íšŒì› ê°€ì… /ì¡°íšŒ
  - íšŒì› ë“±ê¸‰ (ì¼ë°˜ & VIP)

> íšŒì› ë°ì´í„°ëŠ” ìì²´ DBë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆê³ , ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™í•  ìˆ˜ ìˆë‹¤.

![image](https://user-images.githubusercontent.com/42997924/180614435-504987f9-b01a-4bc4-b9d8-d29308d768f7.png)

![image](https://user-images.githubusercontent.com/42997924/180614442-384ce1dd-64f5-4fc6-8803-a91e30e106f1.png)

`íšŒì› ì„œë¹„ìŠ¤ : MemberServiceImpl`

### í…ŒìŠ¤íŠ¸í•˜ê¸°

ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!

### ì£¼ë¬¸ê³¼ í• ì¸ ë„ë©”ì¸ ì‹¤í–‰ê³¼ í…ŒìŠ¤íŠ¸

íŒŒì¼êµ¬ì¡°

![image](https://user-images.githubusercontent.com/42997924/180614449-e8636755-3eeb-40d8-b35e-335bc493b012.png)

- Order

  ```java
  import lombok.Data;

  @Data
  public class Order {
      private Long memberId;
      private String itemName;
      private int itemPrice;
      private int discount;

      public Order(Long memberId, String itemName, int itemPrice, int discountPrice) {
          this.memberId = memberId;
          this.itemName = itemName;
          this.itemPrice = itemPrice;
          this.discount = discountPrice;
      }

      public Order(Long memberId, String itemName, int itemPrice) {
          this.memberId = memberId;
          this.itemName = itemName;
          this.itemPrice = itemPrice;
      }

      public int calculatePrice() {
          return itemPrice - discount;
      }
  }

  ```
- OrderService

  ```java
  public interface OrderService {
      Order createOrder(Long memberId, String itemName, int itemPrice);
  }

  ```
- OrderServiceImpl

  ```java
  public class OrderServiceImpl implements OrderService{

      private final MemberRepository memberRepository = new MemoryMemberRepository();
      private final DiscountPolicy discountPolicy = new FixDiscountPolicy();

      @Override
      public Order createOrder(Long memberId, String itemName, int itemPrice) {
          Member member = memberRepository.findById(memberId);
          int discountPrice = discountPolicy.discount(member, itemPrice);

          return new Order(memberId, itemName, itemPrice, discountPrice);
      }
  }

  ```
- OrderApp

  ```java
  public class OrderApp {
      public static void main(String[] args) {
          MemberService memberService = new MemberServiceImpl();
          OrderService orderService = new OrderServiceImpl();

          Long memberId = 1L;
          Member member = new Member(memberId, "itemA", Grade.VIP);
          memberService.join(member);

          Order order = orderService.createOrder(memberId, "itemA", 10000);

          System.out.println("order : " + order);
      }
  }

  ```
- OrderServiceTest

  ```java
  class OrderServiceTest {

      MemberService memberService = new MemberServiceImpl();
      OrderService orderService = new OrderServiceImpl();

      @Test
      void createOrder() {
          Long memberId = 1L;
          Member member = new Member(memberId, "memberA", Grade.VIP);
          memberService.join(member);

          Order order = orderService.createOrder(memberId, "itemA", 10000);
          Assertions.assertThat(order.getDiscount()).isEqualTo(1000);
      }
  }
  ```

### ìƒˆë¡œìš´ í• ì¸ ì •ì±… ì ìš©ê³¼ ë¬¸ì œì 

- DIë¥¼ ì§€í‚¤ì§€ ëª»í•˜ëŠ” ë¬¸ì œì  íŒŒì•…
- ê´€ì‹¬ì‚¬ ë¶„ë¦¬ â†’ ë¦¬íŒ©í„°ë§

1. **í• ì¸ì •ì±… ì ìš©**

   - RateDiscountPolicy

     ```java
     public class RateDiscountPolicy implements DiscountPolicy{

         private final int discountPercent = 10;

         @Override
         public int discount(Member member, int price) {
             if(member.getGrade() == Grade.VIP) {
                 return price * discountPercent / 100;
             }
             else {
                 return 0;
             }
         }
     }

     ```
     
   - RateDiscountPolicyTest

     ```java
     class RateDiscountPolicyTest {

         RateDiscountPolicy discountPolicy = new RateDiscountPolicy();

         @Test
         @DisplayName("VIP ëŠ” 10% í• ì¸ì´ ì ìš©ë˜ì–´ì•¼ í•œë‹¤.")
         void vip_o() {
             // given
             Member member = new Member(1L, "memberVIP", Grade.VIP);

             // when
             int discount = discountPolicy.discount(member, 10000);

             // then
             Assertions.assertThat(discount).isEqualTo(1000);
         }

         @Test
         @DisplayName("VIP ì•„ë‹ˆë©´ í• ì¸ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.")
         void vip_x() {
             // given
             Member member = new Member(1L, "memberVIP", Grade.BASIC);

             // when
             int discount = discountPolicy.discount(member, 10000);

             // then
             Assertions.assertThat(discount).isEqualTo(0);
         }
     }
     ```
     
2. **ë¬¸ì œì  ë°œê²¬**

   <aside>
   
    ğŸ’¡ í´ë¼ì´ì–¸íŠ¸ì¸ OrderServiceImpl ë¥¼ ìˆ˜ì •í•´ì•¼í•˜ëŠ” ë¬¸ì œ

   </aside>

   1. ì—­í• ê³¼ êµ¬í˜„ ì¶©ì‹¤í•˜ê²Œ ë¶„ë¦¬

      ```java
      // OrderServiceImpl ì½”ë“œ ë³€ê²½ ë¶ˆê°€í”¼

      // private final DiscountPolicy = new FixDiscountPolicy();
      private final DiscountPolicy = new RateDiscountPolicy();
      ```
   2. ë‹¤í˜•ì„± í™œìš©, ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ ê°ì²´ ë¶„ë¦¬

      1. OCP, DIP ê°™ì€ ê°ì²´ì§€í–¥ ì„¤ê³„ ì›ì¹™ ì¤€ìˆ˜ â†’ ê·¸ë ‡ê²Œ ë³´ì´ì§€ë§Œ ì‚¬ì‹¤ì€ ì•„ë‹˜

      ![image](https://user-images.githubusercontent.com/42997924/180614552-4b1521ae-5f59-43d6-9ed9-4cd380a96b94.png)

   - OrderServiceImpl

     ```java
     public class OrderServiceImpl implements OrderService{

         private final MemberRepository memberRepository = new MemoryMemberRepository();
     //    private final DiscountPolicy discountPolicy = new FixDiscountPolicy();
         private final DiscountPolicy discountPolicy = new RateDiscountPolicy();

         @Override
         public Order createOrder(Long memberId, String itemName, int itemPrice) {
             Member member = memberRepository.findById(memberId);
             int discountPrice = discountPolicy.discount(member, itemPrice);

             return new Order(memberId, itemName, itemPrice, discountPrice);
         }
     }

     ```
   - ì¶”ìƒí´ë˜ìŠ¤, êµ¬í˜„í´ë˜ìŠ¤ ë‘˜ë‹¤ ì˜ì¡´í•˜ê²Œ ë˜ì–´ë²„ë ¸ë‹¤.

     <aside>
     
       ğŸ’¡ ì˜ì¡´ì„± ì—­ì „ì€ ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•´ë¼! ê°€ ì›ì¹™ì´ë‹¤.

     </aside>
   - OCP : ë³€ê²½í•˜ì§€ ì•Šê³  í™•ì¥í•  ìˆ˜ ìˆë‹¤ê³  í–ˆëŠ”ë°.. â†’ OCP ìœ„ë°˜

3. **ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?**

   <aside>
   
    ğŸ’¡ DIPë¥¼ ìœ„ë°˜í•˜ì§€ ì•Šë„ë¡ ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•˜ë„ë¡ **ì˜ì¡´ê´€ê³„ë¥¼ ë³€ê²½**í•˜ì.

   </aside>

   - OrderServiceImpl

     ```java

     public class OrderServiceImpl implements OrderService{

         private final MemberRepository memberRepository = new MemoryMemberRepository();
     //    private final DiscountPolicy discountPolicy = new FixDiscountPolicy();
     //    private final DiscountPolicy discountPolicy = new RateDiscountPolicy();
         private DiscountPolicy discountPolicy; // final ì€ ê°’ì´ í• ë‹¹ë˜ì–´ì•¼í•´ì„œ ì§€ì›€.

         @Override
         public Order createOrder(Long memberId, String itemName, int itemPrice) {
             Member member = memberRepository.findById(memberId);
             int discountPrice = discountPolicy.discount(member, itemPrice);

             return new Order(memberId, itemName, itemPrice, discountPrice);
         }
     }

     ```
   - Test ì‹¤í–‰í•˜ë©´ NPE ëœ¬ë‹¤. â†’ í• ë‹¹ì´ ì•ˆë˜ì–´ìˆìœ¼ë‹ˆ..

     â‡’ DIPë¥¼ ì§€ì¼°ë”ë‹ˆ NPE. í•´ê²°ë°©ë²•ì€?

<aside>

ğŸ’¡ í´ë¼ì´ì–¸íŠ¸(OrderServiceImpl)ì— Interface êµ¬í˜„ ê°ì²´ë¥¼ ëŒ€ì‹  ì£¼ì…í•´ì£¼ì–´ì•¼ í•œë‹¤!

</aside>

### ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬

1. ë¬¸ì œ êµ¬ì²´í™”

   - ë¡œë¯¸ì˜¤ ì—­í• ì„ í•˜ëŠ” ì¸ë¬¼Aê°€ ì¤„ë¦¬ì—£ ì—­í• ì„ í•˜ëŠ” ì¸ë¬¼Bë¥¼ ì„ íƒí•˜ëŠ” ë¬¸ì œ

     `ì„­ì™¸ì— ëŒ€í•œ ì±…ì„ì€ ê¸°íšì—ì„œ í•´ì•¼ í•¨!`
   - ì£¼ë¬¸ì„œë¹„ìŠ¤(OrderService) ì—­í• ì„ í•˜ëŠ” êµ¬í˜„ì²´(Impl)ì´
     í• ì¸ì •ì±…(DiscountPolicy) ì—­í• ì„ í•˜ëŠ” êµ¬í˜„ì²´(Fix or Rate)ë¥¼ ì§ì ‘ ì„ íƒí•˜ëŠ” ë¬¸ì œ

   <aside>
   
    ğŸ’¡ ê´€ì‹¬ì‚¬ë¥¼ ë¶„ë¦¬í•˜ì!
   
   </aside>

   - ì—­í• ì— ëŒ€í•œ êµ¬í˜„ì„ ì„ íƒí•´ì£¼ëŠ” `ê³µì—° ê¸°íšì`ë¥¼ ì¶”ê°€í•´ì„œ ì±…ì„ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.

2. AppConfig ë“±ì¥
   
   - ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ ë™ì‘ ë°©ì‹ì„ êµ¬ì„±(Config)í•˜ê¸° ìœ„í•¨

     â‡’ êµ¬í˜„ ê°ì²´ë¥¼ ìƒì„± â†’ ì—°ê²° í•˜ëŠ” ì±…ì„ì„ ê°€ì§€ëŠ” ë³„ë„ì˜ ì„¤ì • í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì!
   - OrderServiceImpl

     ```java
     public class OrderServiceImpl implements OrderService{

         private final MemberRepository memberRepository;
         private final DiscountPolicy discountPolicy;

         public OrderServiceImpl(MemberRepository memberRepository, DiscountPolicy discountPolicy) {
             this.memberRepository = memberRepository;
             this.discountPolicy = discountPolicy;
         }

         @Override
         public Order createOrder(Long memberId, String itemName, int itemPrice) {
             Member member = memberRepository.findById(memberId);
             int discountPrice = discountPolicy.discount(member, itemPrice);

             return new Order(memberId, itemName, itemPrice, discountPrice);
         }
     }
     ```
   - MemberServiceImpl

     ```java
     public class MemberServiceImpl implements MemberService {

         private final MemberRepository memberRepository;

         public MemberServiceImpl(MemberRepository memberRepository) {
             this.memberRepository = memberRepository;
         }

         @Override
         public void join(Member member) {
             memberRepository.save(member);
         }

         @Override
         public Member findMember(Long memberId) {
             return memberRepository.findById(memberId);
         }
     }

     ```
   - AppConfig

     ```java
     public class AppConfig {

         public MemberService memberService() {
             return new MemberServiceImpl(new MemoryMemberRepository());
         }

         public OrderService orderService() {
             return new OrderServiceImpl(new MemoryMemberRepository(), new FixDiscountPolicy());
         }
     }

     ```

   <aside>
   
    ğŸ’¡ ì„œë¹„ìŠ¤ëŠ” ì´ì œ Repositoryì˜ ì¸í„°í˜ì´ìŠ¤ë§Œ ë³´ê³  ìˆìŒ!  
    **ì‹¤ì œ ë™ì‘ì— í•„ìš”í•œ êµ¬í˜„ ê°ì²´ëŠ” AppConfigì—ì„œ ìƒì„±**

   </aside>

   - ìƒì„±í•œ ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì˜ ì°¸ì¡°(ë ˆí¼ëŸ°ìŠ¤)ë¥¼ **ìƒì„±ìë¥¼ í†µí•´ì„œ ì£¼ì…(ì—°ê²°)**í•´ì¤€ë‹¤.

     ![image](https://user-images.githubusercontent.com/42997924/180614621-de6a82e1-f95e-4e1c-8043-177f7d9ceb26.png)
   
   - MemberApp

     ```java
     public class MemberApp {
         public static void main(String[] args) {
             AppConfig appConfig = new AppConfig();
             MemberService memberService = appConfig.memberService();
             Member member = new Member(1L, "memberA", Grade.VIP);
             memberService.join(member);

             Member findMember = memberService.findMember(1L);
             System.out.println("new Member : " + findMember.getName());
         }
     }

     ```
   - OrderApp

     ```java
     public class OrderApp {
         public static void main(String[] args) {
             AppConfig appConfig = new AppConfig();

             MemberService memberService = appConfig.memberService();
             OrderService orderService = appConfig.orderService();

             Long memberId = 1L;
             Member member = new Member(memberId, "itemA", Grade.VIP);
             memberService.join(member);

             Order order = orderService.createOrder(memberId, "itemA", 10000);

             System.out.println("order : " + order);
         }
     }

     ```
   - MemberServiceTest

     ```java
     class MemberServiceTest {

         MemberService memberService;

         /**
          * ê° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì‹œ í•œë²ˆ ì”© í˜¸ì¶œ
          */
         @BeforeEach
         public void beforeEach() {
             AppConfig appConfig = new AppConfig();
             memberService = appConfig.memberService();
         }

         @Test
         void join() {
             // given
             Member member = new Member(1L, "Hi", Grade.BASIC);

             // when
             memberService.join(member);
             Member findMember = memberService.findMember(1L);

             // then
             Assertions.assertThat(member).isEqualTo(findMember);

         }

     }
     ```
   - OrderServiceTest

     ```java
     import static org.junit.jupiter.api.Assertions.*;

     class OrderServiceTest {

         AppConfig appConfig = new AppConfig();
         MemberService memberService;
         OrderService orderService;

         /**
          * ê° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì‹œ í•œë²ˆ ì”© í˜¸ì¶œ
          */
         @BeforeEach
         public void beforeEach() {
             AppConfig appConfig = new AppConfig();
             memberService = appConfig.memberService();
             orderService = appConfig.orderService();
         }

         @Test
         void createOrder() {
             Long memberId = 1L;
             Member member = new Member(memberId, "memberA", Grade.VIP);
             memberService.join(member);

             Order order = orderService.createOrder(memberId, "itemA", 10000);
             Assertions.assertThat(order.getDiscount()).isEqualTo(1000);
         }
     }
     ```

   **ì—­í• ê³¼ ì±…ì„ì„ ì ì ˆíˆ ì˜ ë‚˜ëˆ ì„œ DIì™€ ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì˜ ì§€ì¼°ë‹¤!**

### AppConfig ë¦¬íŒ©í„°ë§

- Configë€ ì „ì²´ êµ¬ì¡°ì— ëŒ€í•œ ì—­í• â†”êµ¬í˜„ì´ í•œëˆˆì— ë³´ì—¬ì•¼ í•¨
- í˜„ì¬ êµ¬ì¡° â‡’ ì „í˜€ ì•ˆë³´ì„.

  ```java
  public class AppConfig {

      public MemberService memberService() {
          return new MemberServiceImpl(new MemoryMemberRepository());
      }

      public OrderService orderService() {
          return new OrderServiceImpl(new MemoryMemberRepository(), new FixDiscountPolicy());
      }
  }

  ```
- ì¤‘ë³µ ì œê±° & ì—­í• ê³¼ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë©”ì„œë“œ ëª…ê³¼ return íƒ€ì…ë§Œ ë³´ê³  êµ¬ë¶„í•  ìˆ˜ ìˆë„ë¡ ë¦¬íŒ©í„°ë§

  ```java
  public class AppConfig {

      public MemberService memberService() {
          return new MemberServiceImpl(getMemberRepository());
      }

      private MemberRepository getMemberRepository() {
          return new MemoryMemberRepository();
      }

      public OrderService orderService() {
          return new OrderServiceImpl(getMemberRepository(), getDiscountPolicy());
      }

      public DiscountPolicy getDiscountPolicy() {
          return new FixDiscountPolicy();
      }
  }

  ```

### ìƒˆë¡œìš´ êµ¬ì¡°ì™€ í• ì¸ ì •ì±… ì ìš©

ì •ì•¡ í• ì¸ ì •ì±… â‡’ ì •ë¥ (%) í• ì¸ ì •ì±… ë³€ê²½

![image](https://user-images.githubusercontent.com/42997924/180614669-2a233fec-a88b-4656-a94d-afd15d1829a2.png)

<aside>

ğŸ’¡ ì˜ì—­ì´ ë‚˜ëˆ ì§ (ì‚¬ìš© & êµ¬ì„±)  
êµ¬ì„± ì˜ì—­ì˜ ì½”ë“œë§Œ ë°”ê¾¸ë©´ ë¨!

</aside>

- AppConfig

  ```java
  public class AppConfig {

      public MemberService memberService() {
          return new MemberServiceImpl(getMemberRepository());
      }

      private MemberRepository getMemberRepository() {
          return new MemoryMemberRepository();
      }

      public OrderService orderService() {
          return new OrderServiceImpl(getMemberRepository(), getDiscountPolicy());
      }

      public DiscountPolicy getDiscountPolicy() {
  //        return new FixDiscountPolicy();
          return new RateDiscountPolicy();
      }
  }

  ```

<aside>

ğŸ’¡ ì´ì œ OCP ë§Œì¡±!  
â†’ í™•ì¥ì—ëŠ” ì—´ë¦¬ê³ , ë³€ê²½ì€ ë‹«íŒë‹¤.  
(í´ë¼ì´ì–¸íŠ¸ ë³€ê²½ X â†’ AppConfigë¥¼ í†µí•´ í™•ì¥ì€ ë¬´í•œìœ¼ë¡œ ì—´ë ¸ë‹¤)

</aside>
